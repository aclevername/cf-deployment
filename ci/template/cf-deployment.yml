#@ load("@ytt:data", "data")
#@ load("helpers.lib.yml",
#@   "delete_deployment",
#@   "add_tcp_domain",
#@   "bosh_clean_up",
#@   "open_asg",
#@   "update_integration_config",
#@   "run_cats",
#@   "ship_it",
#@   "pool_resource",
#@   "acquire_pool",
#@   "release_pool_manual",
#@ )

---
groups:
- name: cf-deployment
  jobs:
  - fresh-deploy
  - fresh-acquire-pool
  - bbr-acquire-pool
  - bbr-deploy
  - bbr-run-drats
  - bbr-release-pool
  - upgrade-deploy
  - upgrade-acquire-pool
  - upgrade-release-pool
  - lite-deploy
  - lite-acquire-pool
  - experimental-deploy
  - lint-cf-deployment-manifest
  - branch-freshness
  - fresh-cats
  - fresh-delete-deployment
  - fresh-smoke-tests
  - upgrade-cats
  - upgrade-cats-windows2016
  - lite-cats
  - lite-recreate-director
  - experimental-cats
  - experimental-smoke-tests
  - experimental-acquire-pool
  - experimental-release-pool
  - unit-test-golang-tests
  - unit-test-ops-files
  - unit-test-update-releases-coverage
  - bless-manifest
  - ship-it-major
  - ship-it-minor
  - ship-it-patch
  - release-notes-template
- name: ex
  jobs:
  - unit-test-golang-tests
  - unit-test-ops-files
  - unit-test-update-releases-coverage
  - experimental-acquire-pool
  - experimental-cats
  - experimental-deploy
  - experimental-release-pool
  - experimental-release-pool-manual
  - experimental-smoke-tests
  - experimental-ops-files
  - bless-manifest
- name: fr
  jobs:
  - unit-test-golang-tests
  - unit-test-ops-files
  - unit-test-update-releases-coverage
  - fresh-acquire-pool
  - fresh-cats
  - fresh-delete-deployment
  - fresh-deploy
  - fresh-release-pool-manual
  - fresh-smoke-tests
  - bless-manifest
- name: up
  jobs:
  - unit-test-golang-tests
  - unit-test-ops-files
  - unit-test-update-releases-coverage
  - upgrade-acquire-pool
  - upgrade-deploy
  - upgrade-cats
  - upgrade-cats-windows2016
  - upgrade-release-pool-manual
  - upgrade-release-pool
  - bless-manifest
- name: li
  jobs:
  - unit-test-golang-tests
  - unit-test-ops-files
  - unit-test-update-releases-coverage
  - lite-acquire-pool
  - lite-cats
  - lite-deploy
  - lite-recreate-director
  - lite-release-pool-manual
  - bless-manifest
- name: bbr
  jobs:
  - unit-test-golang-tests
  - unit-test-ops-files
  - unit-test-update-releases-coverage
  - bbr-acquire-pool
  - bbr-deploy
  - bbr-run-drats
  - bbr-release-pool
  - bbr-release-pool-manual
  - bless-manifest
- name: st
  jobs:
  - stable-acquire-pool
  - stable-deploy
  - stable-smoke-tests
  - stable-semihourly-pool-acquisition
  - stable-periodic-cats
  - stable-release-pool-manual
  - stable-update-cats-cfd-branch
  - cleanup-stable-periodic-cats

resource_types:
- name: terraform
  type: docker-image
  source:
    repository: ljfranklin/terraform-resource
- name: bosh-deployment-v2
  type: docker-image
  source:
    repository: cloudfoundry/bosh-deployment-resource

resources:
#@ for p in data.values.pools:
- #@ pool_resource(p)
#@ end

- name: relint-envs
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/relint-envs.git
    private_key: ((hagrid_env_readwrite_deploy_key.private_key))
- name: half-hourly
  type: time
  source:
    interval: 30m
- name: cf-deployment-concourse-tasks
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git
- name: runtime-ci
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/runtime-ci.git
- name: bosh-bootloader
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/bosh-bootloader
- name: cf-deployment-develop
  type: git
  source:
    branch: develop
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: ((cf_deployment_readwrite_deploy_key.private_key))
    ignore_paths:
    - .envrc
    - .overcommit.yml
    - ISSUE_TEMPLATE.md
    - PULL_REQUEST_TEMPLATE.md
    - ci/**
    - texts/**
- name: cf-deployment-release-candidate
  type: git
  source:
    branch: release-candidate
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: ((cf_deployment_readwrite_deploy_key.private_key))
    ignore_paths:
    - .envrc
    - .overcommit.yml
    - ISSUE_TEMPLATE.md
    - PULL_REQUEST_TEMPLATE.md
    - ci/**
    - texts/**
- name: cf-deployment-all-branches
  type: git
  source:
    branch: develop
    uri: https://github.com/cloudfoundry/cf-deployment.git
    ignore_paths:
    - .envrc
    - .overcommit.yml
    - ISSUE_TEMPLATE.md
    - PULL_REQUEST_TEMPLATE.md
    - ci/**
    - texts/**
- name: cf-acceptance-tests-rc
  type: git
  source:
    branch: release-candidate
    uri: git@github.com:cloudfoundry/cf-acceptance-tests.git
    private_key: ((cf_acceptance_tests_readwrite_deploy_key.private_key))
- name: cf-acceptance-tests
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/cf-acceptance-tests.git
    private_key: ((cf_acceptance_tests_readwrite_deploy_key.private_key))
- name: cf-smoke-tests
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-smoke-tests
- name: cf-deployment-master
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: ((cf_deployment_readwrite_deploy_key.private_key))
    ignore_paths:
    - .envrc
    - .overcommit.yml
    - ISSUE_TEMPLATE.md
    - PULL_REQUEST_TEMPLATE.md
    - ci/**
    - texts/**
- name: bosh-deployment
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/bosh-deployment.git
- name: cf-deployment-version
  type: semver
  source:
    driver: git
    uri: git@github.com:cloudfoundry/cf-relint-ci-semver.git
    branch: master
    private_key: ((cf_relint_ci_semver_readwrite_deploy_key.private_key))
    git_user: "CF MEGA BOT <cf-mega@pivotal.io>"
    file: cf-deployment-version
- name: deliver-tracker-story
  type: tracker
  source:
    token: ((cf_relint_tracker_api_token))
    project_id: "1382120"
    tracker_url: https://www.pivotaltracker.com
- name: drats-master
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry-incubator/disaster-recovery-acceptance-tests.git
- name: bbr-github-release
  type: github-release
  source:
    owner: cloudfoundry-incubator
    repository: bosh-backup-and-restore

jobs:
- name: branch-freshness
  public: true
  plan:
  - aggregate:
    - get: cf-deployment-all-branches
      trigger: true
    - get: runtime-ci
  - task: validate-branch-freshness
    file: runtime-ci/tasks/validate-branch-freshness/task.yml
    input_mapping:
      repo: cf-deployment-all-branches

#@ for p in data.values.pools:
#@ if/end p!="stable":
- #@ acquire_pool(p)
- #@ release_pool_manual(p)
#@ end

- name: lint-cf-deployment-manifest
  serial: false
  public: true
  plan:
  - get: cf-deployment-develop
    trigger: true
  - task: lint-manifest
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: relintdockerhubpushbot/cf-deployment-concourse-tasks
      inputs:
      - name: cf-deployment-develop
      run:
        path: /bin/bash
        args:
        - -exc
        - |
          ruby -e "require 'yaml'; YAML.load_file('./cf-deployment-develop/cf-deployment.yml')"

- name: unit-test-golang-tests
  serial: true
  public: true
  plan:
  - get: cf-deployment-develop
    trigger: true
  - task: unit-test-golang-ops-files
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: relintdockerhubpushbot/bosh-cli
      inputs:
      - name: cf-deployment-develop
      #! params:
      #!   RUN_SEMANTIC: true
      run:
        dir: cf-deployment-develop/units
        path: ./test

- name: unit-test-ops-files
  serial: true
  public: true
  plan:
  - get: cf-deployment-develop
    trigger: true
  - task: unit-test-ops-files
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: relintdockerhubpushbot/bosh-cli
      inputs:
      - name: cf-deployment-develop
      params:
        RUN_SEMANTIC: true
      run:
        dir: cf-deployment-develop
        path: scripts/test

- name: unit-test-update-releases-coverage
  serial: true
  public: true
  plan:
  - get: cf-deployment-develop
    trigger: true
  - get: runtime-ci
  - task: unit-test-update-releases-coverage
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: relintdockerhubpushbot/bosh-cli
      inputs:
      - name: cf-deployment-develop
      - name: runtime-ci
      run:
        dir: runtime-ci
        path: scripts/tests/update-releases-coverage-test

- name: fresh-deploy
  serial_groups: [ luna-smokes ]
  public: true
  plan:
  - get: fresh-pool
    trigger: true
    passed: [fresh-acquire-pool]
  - aggregate:
    - get: cf-deployment-develop
      passed: [fresh-acquire-pool]
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
    - get: cf-smoke-tests
  - #@ delete_deployment("luna", True, "luna-cf")
  - task: collect-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    input_mapping:
      base-ops-files: cf-deployment-develop
      new-ops-files: relint-envs
    params:
      BASE_OPS_FILE_DIR: operations
      NEW_OPS_FILES: |
        environments/test/luna/rename-isolation-segment-network.yml
        environments/test/luna/change-postgres-max-connections.yml
  - task: bosh-deploy-cf
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      bbl-state: relint-envs
      cf-deployment: cf-deployment-develop
      ops-files: collected-ops-files
      vars-files: relint-envs
    params:
      BBL_STATE_DIR: environments/test/luna/bbl-state
      SYSTEM_DOMAIN: luna.cf-app.com
      OPS_FILES: |
        operations/experimental/fast-deploy-with-downtime-and-danger.yml
        operations/use-compiled-releases.yml
        operations/rename-network-and-deployment.yml
        operations/set-bbs-active-key.yml
        operations/test/add-persistent-isolation-segment-diego-cell.yml
        operations/test/add-persistent-isolation-segment-router.yml
        operations/rename-isolation-segment-network.yml
        operations/addons/enable-component-syslog.yml
        operations/use-postgres.yml
        operations/experimental/enable-tls-cloud-controller-postgres.yml
        operations/change-postgres-max-connections.yml
      VARS_FILES: |
        environments/test/luna/deployment-name.yml
        environments/test/luna/network-name.yml
        environments/test/luna/bbs-key-label.yml
        environments/test/luna/syslog-vars.yml
      REGENERATE_CREDENTIALS: true
  - #@ bosh_clean_up("luna")
  - #@ update_integration_config("luna")
  - task: ensure-gcloud-backend-service-healthy
    file: runtime-ci/tasks/ensure-gcloud-backend-service-healthy/task.yml
    input_mapping:
      google-creds-dir: relint-envs
    params:
      GCP_PROJECT_ID: ((luna_gcp_project))
      GCP_BACKEND_SERVICE: ((luna_router_backend_service))
      GOOGLE_ACCOUNT_CREDS_PATH: environments/test/luna/google_account_creds.json
  - aggregate:
    - task: ensure-api-healthy
      file: runtime-ci/tasks/ensure-api-healthy/task.yml
      input_mapping:
        cats-integration-config: relint-envs
      params:
        CONFIG_FILE_PATH: environments/test/luna/integration_config.json
    - task: ensure-isolation-segment-healthy
      file: runtime-ci/tasks/ensure-api-healthy/task.yml
      input_mapping:
        cats-integration-config: relint-envs
      params:
        CHECK_ISOLATION_SEGMENT: true
        CONFIG_FILE_PATH: environments/test/luna/integration_config.json
  - aggregate:
    - #@ open_asg("luna", "credhub", "luna-cf")
    - #@ open_asg("luna", "uaa", "luna-cf")
    - task: enable-docker-and-tasks
      attempts: 2
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        bbl-state: relint-envs
      params:
        BBL_STATE_DIR: environments/test/luna/bbl-state
        SYSTEM_DOMAIN: luna.cf-app.com
        ENABLED_FEATURE_FLAGS: |
          diego_docker
          task_creation

- name: upgrade-deploy
  serial: true
  public: true
  plan:
  - get: upgrade-pool
    trigger: true
    passed: [upgrade-acquire-pool]
  - aggregate:
    - get: cf-deployment-develop
      passed: [upgrade-acquire-pool]
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
  - #@ add_tcp_domain("trelawney")
  - task: collect-ops-files
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    input_mapping:
      base-ops-files: cf-deployment-develop
      new-ops-files: relint-envs
    params:
      BASE_OPS_FILE_DIR: operations
      NEW_OPS_FILES: |
        environments/test/trelawney/add-external-ips-for-cloud-sql-db.yml
        environments/test/trelawney/increase-doppler-vm-type-from-minimal-to-small.yml
        environments/test/trelawney/scale-diego-cell-to-3.yml
  - task: bosh-deploy-cf
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      bbl-state: relint-envs
      cf-deployment: cf-deployment-develop
      ops-files: collected-ops-files
      vars-files: relint-envs
    params:
      BBL_STATE_DIR: environments/test/trelawney/bbl-state
      SYSTEM_DOMAIN: trelawney.cf-app.com
      OPS_FILES: |
        operations/use-compiled-releases.yml
        operations/use-external-dbs.yml
        operations/add-external-ips-for-cloud-sql-db.yml
        operations/windows2012R2-cell.yml
        operations/windows1803-cell.yml
        operations/experimental/use-compiled-releases-windows.yml
        operations/bits-service/use-bits-service.yml
        operations/use-external-blobstore.yml
        operations/use-gcs-blobstore-service-account.yml
        operations/bits-service/configure-bits-service-gcs-service-account.yml
        operations/enable-service-discovery.yml
        operations/test/add-persistent-isolation-segment-diego-cell.yml
        operations/increase-doppler-vm-type-from-minimal-to-small.yml
        operations/scale-diego-cell-to-3.yml
      VARS_FILES: |
        environments/test/trelawney/external-db-vars.yml
        environments/test/trelawney/gcs-vars.yml
      DEPLOY_WITH_UPTIME_MEASUREMENTS: true
      MEASURE_SYSLOG_AVAILABILITY: true
      FAIL_ON_DOWNTIME: true
      TCP_DOMAIN: tcp.trelawney.cf-app.com
      AVAILABLE_PORT: 1033
      HTTP_AVAILABILITY_THRESHOLD: 0
      APP_PUSHABILITY_THRESHOLD: 2
      RECENT_LOGS_THRESHOLD: 8
      STREAMING_LOGS_THRESHOLD: 2
      APP_SYSLOG_AVAILABILITY_THRESHOLD: 12
  - #@ bosh_clean_up("trelawney")
  - #@ update_integration_config("trelawney")
  - aggregate:
    - #@ open_asg("trelawney", "credhub")
    - #@ open_asg("trelawney", "uaa")
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        bbl-state: relint-envs
      params:
        BBL_STATE_DIR: environments/test/trelawney/bbl-state
        SYSTEM_DOMAIN: trelawney.cf-app.com
        ENABLED_FEATURE_FLAGS: |
          diego_docker
          task_creation
          service_instance_sharing

- name: experimental-release-pool
  public: true
  plan:
  - get: experimental-pool
    passed: [ experimental-cats, experimental-smoke-tests ]
    trigger: true
  - put: experimental-pool
    params: {release: experimental-pool}

- name: stable-acquire-pool
  public: true
  serial: true
  plan:
  - aggregate:
    - get: cf-deployment-master
      trigger: true
    - put: stable-pool
      params: {acquire: true}

- name: upgrade-release-pool
  public: true
  plan:
  - get: upgrade-pool
    passed: [ upgrade-cats, upgrade-cats-windows2016 ]
    trigger: true
  - put: upgrade-pool
    params: {release: upgrade-pool}

- name: bbr-release-pool
  public: true
  plan:
  - get: bbr-pool
    passed: [ bbr-run-drats ]
    trigger: true
  - put: bbr-pool
    params: {release: bbr-pool}

- name: experimental-ops-files
  public: true
  plan:
  - aggregate:
    - get: experimental-pool
      trigger: true
      passed: [ experimental-acquire-pool ]
    - get: runtime-ci
  - task: experimental-ops-files
    file: runtime-ci/tasks/summarize-ops-files/task.yml

- name: experimental-deploy
  serial_groups: [ hermione-wats, hermione-cats, hermione-smokes ]
  public: true
  plan:
  - do:
    - get: experimental-pool
      trigger: true
      passed: [ experimental-acquire-pool ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: cf-deployment-develop
        passed: [ experimental-acquire-pool ]
      - get: relint-envs
    - #@ add_tcp_domain("hermione")
    - task: collect-ops-files
      file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
      input_mapping:
        base-ops-files: cf-deployment-develop
        new-ops-files: relint-envs
      params:
        BASE_OPS_FILE_DIR: operations
        NEW_OPS_FILES: |
          environments/test/hermione/increase-doppler-vm-type-from-minimal-to-small.yml
    - task: bosh-deploy-cf
      file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
      input_mapping:
        bbl-state: relint-envs
        cf-deployment: cf-deployment-develop
        ops-files: collected-ops-files
        vars-files: relint-envs
      params:
        BBL_STATE_DIR: environments/test/hermione/bbl-state
        SYSTEM_DOMAIN: hermione.cf-app.com
        OPS_FILES: |
          operations/use-compiled-releases.yml
          operations/use-external-blobstore.yml
          operations/use-s3-blobstore.yml
          operations/bits-service/use-bits-service.yml
          operations/bits-service/configure-bits-service-s3.yml
          operations/scale-database-cluster.yml
          operations/stop-skipping-tls-validation.yml
          operations/use-operator-provided-router-tls-certificates.yml
          operations/experimental/enable-iptables-logger.yml
          operations/experimental/set-cpu-weight.yml
          operations/experimental/deploy-forwarder-agent.yml
          operations/experimental/use-logcache-for-cloud-controller-app-stats.yml
          operations/experimental/add-syslog-agent.yml
          operations/increase-doppler-vm-type-from-minimal-to-small.yml
        VARS_FILES: |
          environments/test/hermione/bbl-state/vars/director-vars-file.yml
          environments/test/hermione/vars-use-operator-provided-router-tls-certificates.yml
        DEPLOY_WITH_UPTIME_MEASUREMENTS: true
        MEASURE_SYSLOG_AVAILABILITY: true
        TCP_DOMAIN: tcp.hermione.cf-app.com
        AVAILABLE_PORT: 1033
        APP_PUSHABILITY_THRESHOLD: 5
        HTTP_AVAILABILITY_THRESHOLD: 0
        RECENT_LOGS_THRESHOLD: 11
        STREAMING_LOGS_THRESHOLD: 3
        APP_SYSLOG_AVAILABILITY_THRESHOLD: 5
        FAIL_ON_DOWNTIME: true
    - #@ bosh_clean_up("hermione")
    - #@ update_integration_config("hermione")
    - aggregate:
      - #@ open_asg("hermione", "credhub")
      - #@ open_asg("hermione", "uaa")
      - task: set-feature-flags
        file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
        input_mapping:
          bbl-state: relint-envs
        params:
          BBL_STATE_DIR: environments/test/hermione/bbl-state
          SYSTEM_DOMAIN: hermione.cf-app.com
          ENABLED_FEATURE_FLAGS: |
            diego_docker
            task_creation
            service_instance_sharing

- name: stable-deploy
  serial_groups: [ bellatrix-smokes ]
  public: true
  plan:
  - on_success:
      put: stable-pool
      params: {release: stable-pool}
    do:
    - get: stable-pool
      trigger: true
      passed: [ stable-acquire-pool ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: cf-deployment-master
      - get: relint-envs
    - task: collect-ops-files
      file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
      input_mapping:
        base-ops-files: cf-deployment-master
        new-ops-files: relint-envs
      params:
        BASE_OPS_FILE_DIR: "operations"
        NEW_OPS_FILES: |
          environments/test/bellatrix/decrease-cc-event-retention.yml
    - task: bosh-deploy-cf
      file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
      input_mapping:
        bbl-state: relint-envs
        cf-deployment: cf-deployment-master
        ops-files: collected-ops-files
        vars-files: relint-envs
      params:
        BBL_STATE_DIR: environments/test/bellatrix/bbl-state
        SYSTEM_DOMAIN: bellatrix.cf-app.com
        OPS_FILES: |
          operations/scale-database-cluster.yml
          operations/windows2016-cell.yml
          operations/decrease-cc-event-retention.yml
    - #@ bosh_clean_up("bellatrix")
    - #@ update_integration_config("bellatrix")
    - #@ open_asg("bellatrix", "credhub")
    - #@ open_asg("bellatrix", "uaa")

- name: lite-deploy
  public: true
  serial_groups: [ snitch-cats ]
  plan:
  - timeout: 4h
    do:
    - get: lite-pool
      trigger: true
      passed: [lite-acquire-pool]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-concourse-tasks
      - get: cf-deployment-develop
        passed: [lite-acquire-pool]
      - get: bosh-deployment
      - get: relint-envs
    - #@ delete_deployment("snitch", True)
    - task: collect-ops-files
      file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
      input_mapping:
        base-ops-files: cf-deployment-develop
        new-ops-files: relint-envs
      params:
        BASE_OPS_FILE_DIR: operations
        NEW_OPS_FILES: |
          environments/test/snitch/use-default-route-registrar-timeout-for-api.yml
          environments/test/snitch/use-debug-level-logging.yml
    - task: bosh-deploy-cf
      file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
      input_mapping:
        bbl-state: relint-envs
        cf-deployment: cf-deployment-develop
        ops-files: collected-ops-files
        vars-files: relint-envs
      params:
        BBL_STATE_DIR: environments/test/snitch/bbl-state
        SYSTEM_DOMAIN: snitch.cf-app.com
        OPS_FILES: |
          operations/use-default-route-registrar-timeout-for-api.yml
          operations/experimental/fast-deploy-with-downtime-and-danger.yml
          operations/use-compiled-releases.yml
          operations/bosh-lite.yml
          operations/use-debug-level-logging.yml
        REGENERATE_CREDENTIALS: true
        BOSH_LITE: true
    - #@ bosh_clean_up("snitch")
    - #@ update_integration_config("snitch")
    - aggregate:
      - #@ open_asg("snitch", "credhub")
      - #@ open_asg("snitch", "uaa")
      - task: enable-docker-and-tasks
        file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
        input_mapping:
          bbl-state: relint-envs
        params:
          BBL_STATE_DIR: environments/test/snitch/bbl-state
          SYSTEM_DOMAIN: snitch.cf-app.com
          ENABLED_FEATURE_FLAGS: |
            diego_docker
            task_creation

- name: experimental-cats
  serial_groups: [ hermione-cats ]
  public: true
  plan:
  - timeout: 4h
    do:
    - get: experimental-pool
      trigger: true
      passed: [ experimental-deploy ]
    - aggregate:
      - get: cf-acceptance-tests-rc
      - get: relint-envs
      - get: cf-deployment-develop
        passed: [ experimental-deploy ]
      - get: cf-deployment-concourse-tasks
    - #@ run_cats("hermione")

- name: experimental-smoke-tests
  public: true
  serial_groups: [ hermione-smokes ]
  plan:
  - do:
    - get: experimental-pool
      passed: [ experimental-deploy ]
      trigger: true
    - aggregate:
      - get: relint-envs
      - get: cf-deployment-develop
        passed: [ experimental-deploy ]
      - get: cf-deployment-concourse-tasks
    timeout: 1h
  - task: bosh-run-errand-smoke-tests
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    params:
      BBL_STATE_DIR: environments/test/hermione/bbl-state
      ERRAND_NAME: smoke-tests
    input_mapping:
      bbl-state: relint-envs

- name: fresh-smoke-tests
  public: true
  serial_groups: [ luna-smokes ]
  plan:
  - do:
    - get: fresh-pool
      passed: [ fresh-deploy ]
      trigger: true
    - aggregate:
      - get: relint-envs
      - get: cf-deployment-develop
        passed: [ fresh-deploy ]
      - get: cf-deployment-concourse-tasks
    timeout: 1h
  - task: bosh-run-errand-smoke-tests
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    params:
      BBL_STATE_DIR: environments/test/luna/bbl-state
      ERRAND_NAME: smoke-tests
      DEPLOYMENT_NAME: luna-cf
    input_mapping:
      bbl-state: relint-envs

- name: stable-smoke-tests
  serial_groups: [bellatrix-smokes]
  public: true
  plan:
  - timeout: 1h
    do:
    - get: stable-pool
      trigger: true
      passed: [stable-deploy]
    - aggregate:
      - get: relint-envs
        passed: [stable-deploy]
      - get: cf-deployment-master
        passed: [stable-deploy]
      - get: cf-deployment-concourse-tasks
  - task: bosh-run-errand-smoke-tests
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    input_mapping:
      bbl-state: relint-envs
    params:
      BBL_STATE_DIR: environments/test/bellatrix/bbl-state
      ERRAND_NAME: smoke-tests
    on_failure:
      put: stable-pool
      params: {release: stable-pool}

- name: bbr-deploy
  public: true
  plan:
  - get: bbr-pool
    trigger: true
    passed: [ bbr-acquire-pool ]
  - aggregate:
    - get: cf-deployment-develop
      passed: [bbr-acquire-pool]
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: relint-envs
  - task: bosh-deploy-cf
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      bbl-state: relint-envs
      cf-deployment: cf-deployment-develop
      ops-files: cf-deployment-develop
      vars-files: relint-envs
    params:
      BBL_STATE_DIR: environments/test/bbr/bbl-state
      SYSTEM_DOMAIN: baba-yaga.cf-app.com
      OPS_FILES: |
        operations/use-compiled-releases.yml
        operations/backup-and-restore/enable-backup-restore.yml
        operations/enable-nfs-volume-service.yml
        operations/backup-and-restore/enable-backup-restore-nfs-broker.yml
  - #@ open_asg("bbr", "credhub", system_domain="baba-yaga.cf-app.com")
  - #@ open_asg("bbr", "uaa", system_domain="baba-yaga.cf-app.com")
  - task: run-nfs-broker-push-errand
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    input_mapping:
      bbl-state: relint-envs
    params:
      BBL_STATE_DIR: environments/test/bbr/bbl-state
      ERRAND_NAME: nfs-broker-push
  - #@ bosh_clean_up("bbr")

- name: bbr-run-drats
  public: true
  plan:
  - get: bbr-pool
    trigger: true
    passed: [ bbr-deploy ]
  - aggregate:
    - get: cf-deployment-develop
      passed: [ bbr-deploy ]
    - get: bbr-github-release
    - get: relint-envs
    - get: cf-deployment-concourse-tasks
    - get: drats-master
    - get: runtime-ci
  - task: generate-drats-config
    file: runtime-ci/tasks/generate-drats-config/task.yml
    input_mapping:
      bbl-state: relint-envs
    params:
      BBL_STATE_DIR: environments/test/bbr/bbl-state
      SYSTEM_DOMAIN: baba-yaga.cf-app.com
  - task: run-drats
    privileged: true
    file: drats-master/ci/drats-with-integration-config/task.yml
    input_mapping:
      disaster-recovery-acceptance-tests: drats-master
      bbr-binary-release: bbr-github-release
      drats-integration-config: drats-config

- name: stable-semihourly-pool-acquisition
  serial: true
  public: true
  plan:
  - timeout: 4h
    do:
    - get: half-hourly
      trigger: true
    - put: stable-pool
      params: {claim: bellatrix}

- name: stable-periodic-cats
  serial: true
  public: true
  plan:
  - timeout: 4h
    on_failure:
      put: stable-pool
      params: {release: stable-pool}
    do:
    - get: stable-pool
      trigger: true
      passed: [ stable-semihourly-pool-acquisition ]
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests
      - get: relint-envs
      - get: cf-deployment-master
        passed: [ stable-deploy ]
    - task: enable-docker-and-tasks
      file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
      input_mapping:
        bbl-state: relint-envs
      params:
        BBL_STATE_DIR: environments/test/bellatrix/bbl-state
        SYSTEM_DOMAIN: bellatrix.cf-app.com
        ENABLED_FEATURE_FLAGS: |
          diego_docker
          task_creation
          service_instance_sharing
    - task: run-cats
      file: cf-deployment-concourse-tasks/run-cats/task.yml
      input_mapping:
        integration-config: relint-envs
      params:
        CONFIG_FILE_PATH: environments/test/bellatrix/integration_config.json
        REPORTER_CONFIG_FILE_PATH: environments/test/bellatrix/reporter_config.json
        FLAKE_ATTEMPTS: 0
        RELINT_VERBOSE_AUTH: "true"

- name: cleanup-stable-periodic-cats
  serial: true
  public: true
  plan:
  - timeout: 4h
    do:
    - get: stable-pool
      trigger: true
      passed: [ stable-periodic-cats ]
    - aggregate:
      - get: runtime-ci
      - get: relint-envs
    - task: cleanup-stable-periodic-cats
      file: runtime-ci/tasks/cleanup-after-cats/task.yml
      input_mapping:
        integration-config: relint-envs
      params:
        CONFIG_FILE_PATH: environments/test/bellatrix/integration_config.json

- name: stable-update-cats-cfd-branch
  public: true
  plan:
  - timeout: 4h
    ensure:
      put: stable-pool
      params: {release: stable-pool}
    do:
    - get: stable-pool
      trigger: true
      passed: [ stable-periodic-cats ]
    - aggregate:
      - get: runtime-ci
      - get: cf-deployment-master
        passed: [ stable-periodic-cats ]
      - get: cf-acceptance-tests
        passed: [ stable-periodic-cats ]
    - task: update-branch
      file: runtime-ci/tasks/update-cats-branch-with-cf-deployment-version/task.yml
      input_mapping:
        cf-deployment: cf-deployment-master
      params:
        DEPLOY_KEY: ((cf_acceptance_tests_readwrite_deploy_key.private_key))

- name: fresh-cats
  serial: true
  public: true
  plan:
  - timeout: 4h
    do:
    - get: fresh-pool
      trigger: true
      passed: [ fresh-deploy ]
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests-rc
      - get: relint-envs
      - get: cf-deployment-develop
        passed: [ fresh-deploy ]
    - #@ run_cats("luna", capture_logs=True)

- name: upgrade-cats
  serial: true
  public: true
  plan:
  - timeout: 4h
    do:
    - get: upgrade-pool
      trigger: true
      passed: [upgrade-deploy]
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests-rc
      - get: relint-envs
      - get: cf-deployment-develop
        passed: [upgrade-deploy]
    - #@ run_cats("trelawney", capture_logs=True)

- name: upgrade-cats-windows2016
  serial: true
  public: true
  plan:
  - timeout: 4h
    do:
    - get: upgrade-pool
      trigger: true
      passed: [upgrade-deploy]
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: cf-acceptance-tests-rc
      - get: relint-envs
      - get: cf-deployment-develop
        passed: [upgrade-deploy]
    - task: run-cats
      file: cf-deployment-concourse-tasks/run-cats/task.yml
      input_mapping:
        integration-config: relint-envs
        cf-acceptance-tests: cf-acceptance-tests-rc
      params:
        CAPTURE_LOGS: true
        CONFIG_FILE_PATH: environments/test/trelawney/cats_windows2016_integration_config.json
        REPORTER_CONFIG_FILE_PATH: environments/test/trelawney/reporter_config.json
        NODES: 8
        RELINT_VERBOSE_AUTH: "true"

- name: lite-cats
  serial_groups: [ snitch-cats ]
  public: true
  plan:
  - timeout: 4h
    do:
    - get: lite-pool
      trigger: true
      passed: [ lite-deploy ]
    - aggregate:
      - get: cf-acceptance-tests-rc
      - get: cf-deployment-develop
        passed: [ lite-deploy ]
      - get: relint-envs
      - get: cf-deployment-concourse-tasks
    - #@ run_cats("snitch", nodes=2)

- name: lite-recreate-director
  serial: true
  public: true
  plan:
  - timeout: 4h
    do:
    - get: lite-pool
      trigger: true
      passed:
      - lite-cats
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: relint-envs
      - get: runtime-ci
      - get: bosh-bootloader
    - #@ delete_deployment("snitch", True)
    - task: combine-bbl-configs
      file: runtime-ci/tasks/combine-inputs/task.yml
      input_mapping:
        first-input: bosh-bootloader
        second-input: relint-envs
      params:
        FIRST_DIR: plan-patches/bosh-lite-gcp
        SECOND_DIR: environments/test/snitch/bbl-config
    - task: update-infrastructure
      file: cf-deployment-concourse-tasks/bbl-up/task.yml
      params:
        BBL_STATE_DIR: environments/test/snitch/bbl-state
        BBL_IAAS: gcp
        BBL_GCP_SERVICE_ACCOUNT_KEY: environments/test/snitch/google_account_creds.json
        BBL_GCP_REGION: us-central1
        BBL_ENV_NAME: snitch-lite
        SKIP_LB_CREATION: true
        BBL_CONFIG_DIR: .
        BBL_RECREATE_DIRECTOR: true
      input_mapping:
        bbl-state: relint-envs
        bbl-config: combined-inputs
      ensure:
        put: relint-envs
        params:
          repository: updated-bbl-state
          rebase: true
    - put: lite-pool
      params: {release: lite-pool}

- name: fresh-delete-deployment
  serial: true
  public: true
  plan:
  - timeout: 4h
    do:
    - get: fresh-pool
      trigger: true
      passed:
      - fresh-cats
      - fresh-smoke-tests
    - aggregate:
      - get: cf-deployment-concourse-tasks
      - get: relint-envs
    - #@ delete_deployment("luna", True, "luna-cf")
    - put: fresh-pool
      params: {release: fresh-pool}

- name: bless-manifest
  public: true
  serial: true
  plan:
  - get: cf-deployment-develop
    trigger: true
    passed:
    - fresh-cats
    - fresh-smoke-tests
    - experimental-cats
    - experimental-smoke-tests
    - upgrade-cats
    - upgrade-cats-windows2016
    - bbr-run-drats
    - lite-cats
  - put: cf-deployment-release-candidate
    params:
      repository: cf-deployment-develop
  - put: deliver-tracker-story
    params:
      repos:
        - cf-deployment-develop

- name: release-notes-template
  public: true
  plan:
  - aggregate:
    - get: runtime-ci
    - get: cf-deployment-master
    - get: cf-deployment-release-candidate
      passed:
      - bless-manifest
      trigger: true
  - task: generate-cf-deployment-release-notes-template
    file: runtime-ci/tasks/cf-deployment-release-notes-template/task.yml

- #@ ship_it("patch")
- #@ ship_it("minor")
- #@ ship_it("major")
